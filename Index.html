<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Exemplo de Visão com OpenCV.js</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; }
    video, canvas { margin: 1rem; border: 2px solid #333; border-radius: 8px; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Visão Computacional com OpenCV.js</h1>
  <video id="video" width="320" height="240" autoplay muted></video>
  <canvas id="canvas" width="320" height="240"></canvas>
  <div id="status">Carregando OpenCV...</div>

  <!-- OpenCV.js CDN -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let streaming = false;

    // Inicializa webcam
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then(stream => {
        video.srcObject = stream;
        video.play();
      })
      .catch(err => {
        document.getElementById('status').innerText = "Erro ao acessar webcam: " + err;
      });

    function onOpenCvReady() {
      document.getElementById('status').innerText = "OpenCV.js carregado!";
      streaming = true;
      processVideo();
    }

    function processVideo() {
      if (!streaming) return;

      let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
      let gray = new cv.Mat(video.height, video.width, cv.CV_8UC1);

      const FPS = 30;
      function captureFrame() {
        ctx.drawImage(video, 0, 0, video.width, video.height);
        src.data.set(ctx.getImageData(0, 0, video.width, video.height).data);

        // Converte para escala de cinza
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // Detecta bordas com Canny
        let edges = new cv.Mat();
        cv.Canny(gray, edges, 50, 100);

        // Mostra resultado no canvas
        cv.imshow('canvas', edges);

        edges.delete();
        setTimeout(captureFrame, 1000/FPS);
      }
      captureFrame();
    }
  </script>
</body>
</html>
